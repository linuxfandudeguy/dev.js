<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaScript IDE</title>
    <link rel="stylesheet" href="https://unpkg.com/monaco-editor/min/vs/editor/editor.main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        body {
            background-color: #2e2e2e;
            color: #ddd;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        #container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #controls {
            padding: 10px;
            background: #333;
            border-bottom: 1px solid #444;
        }
        button {
            margin-right: 10px;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .icon {
            margin-right: 5px;
        }
        #editor {
            flex: 1;
            border-bottom: 1px solid #444;
        }
        #console {
            height: 20vh;
            border-top: 1px solid #444;
            background: #1e1e1e;
            padding: 10px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap; /* Preserve whitespace for console output */
        }
        #fileInput {
            display: none;
        }
        #urlModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }
        #urlModalContent {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            width: 400px;
        }
        #urlModalContent input {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 5px;
            color: #ddd;
            background: #222;
            width: calc(100% - 22px); /* Adjust for padding and border */
        }
        #urlModalContent button {
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        #urlModalContent button:hover {
            background: #0056b3;
        }
        #urlModalContent .close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="controls">
            <button id="run"><i class="fas fa-play icon"></i>Run Code</button>
            <button id="save"><i class="fas fa-save icon"></i>Save Code</button>
            <button id="load"><i class="fas fa-upload icon"></i>Load Code</button>
            <button id="import"><i class="fas fa-link icon"></i>Import URL</button>
            <input type="file" id="fileInput">
        </div>
        <div id="editor"></div>
        <div id="console"></div>
    </div>

    <!-- URL Import Modal -->
    <div id="urlModal">
        <div id="urlModalContent">
            <span class="close" id="urlModalClose">&times;</span>
            <input type="text" id="urlInput" placeholder="Enter script URL">
            <button id="urlSubmit">Import Script</button>
        </div>
    </div>

    <!-- Load Babel Standalone and Monaco Editor -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/monaco-editor/min/vs/loader.js"></script>
    <script>
        // Initialize Monaco Editor
        require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor/min/vs' } });
        require(['vs/editor/editor.main'], function() {
            const editor = monaco.editor.create(document.getElementById('editor'), {
                value: '',
                language: 'javascript',
                theme: 'vs-dark'
            });

            const consoleDiv = document.getElementById('console');
            const urlModal = document.getElementById('urlModal');
            const urlInput = document.getElementById('urlInput');
            const urlSubmitButton = document.getElementById('urlSubmit');
            const urlModalCloseButton = document.getElementById('urlModalClose');

            function logToConsole(message, type = 'log') {
                const color = type === 'error' ? 'red' : '#ddd';
                consoleDiv.innerHTML += `${message}\n`;
                consoleDiv.scrollTop = consoleDiv.scrollHeight; // Scroll to bottom
            }

            const originalConsole = {
                log: console.log,
                error: console.error
            };

            console.log = function() {
                logToConsole([...arguments].join(' '), 'log');
                originalConsole.log.apply(console, arguments);
            };

            console.error = function() {
                logToConsole([...arguments].join(' '), 'error');
                originalConsole.error.apply(console, arguments);
            };

            document.getElementById('run').addEventListener('click', () => {
                try {
                    consoleDiv.innerHTML = '';
                    const code = editor.getValue();

                    // Transpile code using Babel
                    const transpiledCode = Babel.transform(code, { presets: ['env'] }).code;

                    // Evaluate transpiled code
                    const sandbox = {
                        console: {
                            log: console.log,
                            error: console.error
                        }
                    };
                    const result = new Function('sandbox', `
                        with (sandbox) {
                            return (function() { ${transpiledCode} })();
                        }
                    `)(sandbox);
                    if (result !== undefined) {
                        console.log(result);
                    }
                } catch (e) {
                    console.error(`Error: ${e.message}`);
                }
            });

            document.getElementById('save').addEventListener('click', () => {
                const blob = new Blob([editor.getValue()], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'code.js';
                a.click();
                URL.revokeObjectURL(url);
            });

            document.getElementById('load').addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });

            document.getElementById('fileInput').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        editor.setValue(e.target.result);
                    };
                    reader.readAsText(file);
                }
            });

            document.getElementById('import').addEventListener('click', () => {
                urlModal.style.display = 'flex'; // Show modal
            });

            urlSubmitButton.addEventListener('click', () => {
                const url = urlInput.value;
                if (url) {
                    fetch(url)
                        .then(response => response.text())
                        .then(data => {
                            editor.setValue(data);
                            urlModal.style.display = 'none'; // Hide modal
                        })
                        .catch(err => {
                            console.error(`Failed to fetch script: ${err.message}`);
                            urlModal.style.display = 'none'; // Hide modal
                        });
                } else {
                    console.error('URL is required.');
                }
            });

            urlModalCloseButton.addEventListener('click', () => {
                urlModal.style.display = 'none'; // Hide modal
            });

            // Close modal if clicked outside of the content
            window.addEventListener('click', (event) => {
                if (event.target === urlModal) {
                    urlModal.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
